<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cliente de escaneo de códigos de barras</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    .card {
      width: 400px;
      margin: 0 auto;
      margin-top: 50px;
      padding: 20px;
    }

    #barcodeResult {
      font-weight: bold;
      font-size: 20px;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col-md-6 offset-md-3">
        <div class="card">
          <h5 class="card-title">Lector de códigos de barras</h5>
          <div class="card-body">
            <video id="videoElement" autoplay></video>
          </div>
          <div class="card-footer">
            <form>
              <div class="mb-3">
                <label for="barcodeResult" class="form-label">Código de barras:</label>
                <input type="text" class="form-control" id="barcodeResult" readonly>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const videoElement = document.getElementById('videoElement');
    const barcodeResultElement = document.getElementById('barcodeResult');

    // Solicitar permiso para acceder a la cámara
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(function (stream) {
        // Asignar el stream de la cámara al elemento de video
        videoElement.srcObject = stream;

        // Esperar a que el evento 'loadedmetadata' se dispare para asegurarse de que el video tenga dimensiones válidas
        videoElement.addEventListener('loadedmetadata', function () {
          // Iniciar el video después de que se haya cargado correctamente
          videoElement.play();

          // Función para capturar un fotograma del video y enviarlo al servidor
          function captureFrameAndSend() {
            // Establecer el tamaño del canvas como el tamaño del video
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;

            // Dibujar el fotograma actual en el canvas
            const context = canvas.getContext('2d');
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            // Convertir la imagen del canvas a un objeto Blob
            canvas.toBlob(function (blob) {
              // Crear una solicitud HTTP para enviar la imagen al servidor
              const formData = new FormData();
              formData.append('image', blob, 'image.jpg');
              fetch('http://192.168.137.1:5000/process-image', {
                method: 'POST',
                body: formData
              })
                .then(response => response.json())
                .then(data => {
                  // Procesar el resultado recibido del servidor
                  if (data.code) {
                    barcodeResultElement.value = data.code;
                  } else {
                    barcodeResultElement.value = 'No se encontró ningún código de barras.';
                  }
                })
                .catch(error => {
                  console.error('Error al enviar la imagen al servidor:', error);
                });
            }, 'image/jpeg');

            // Realizar la captura de fotograma y envío al servidor cada segundo
            setTimeout(captureFrameAndSend, 1000);
          }

          // Iniciar la captura de fotogramas y envío al servidor
          captureFrameAndSend();
        });
      })
      .catch(function (error) {
        console.error('Error al acceder a la cámara:', error);
      });
  </script>
</body>

</html>
